# 分散型ソーシャルネットワークアプリケーション設計書 (Design Document)

## 1. 概要

この文書は、モジュール型の分散型ソーシャルネットワークアプリケーションの設計と実装計画を詳述します。本アプリケーションの主な特徴は、検索やサジェストなどの単機能サービスをモジュール化し、ユーザーが自由に選択できるようにすることです。また、段階的な実装とリリースプランを含み、各ステップの目標と機能を明確にします。

### 1.1 ビジョン

中央集権型プラットフォームの代替として、ユーザーのプライバシーとコントロールを重視した分散型ソーシャルネットワークを構築します。モジュール設計により、ユーザーは好みのサービスプロバイダーを選択でき、多様なコンテンツタイプをサポートする柔軟なエコシステムを目指します。

### 1.2 主要な目標

- 分散型ネットワークの構築によるデータプライバシーと検閲耐性の実現
- ユーザーが検索やサジェスト機能などのサービスプロバイダーを自由に選択できる仕組みの提供
- 段階的な実装を通じた堅牢で使いやすいプラットフォームの構築
- 多様なメディア形式（短文投稿、ブログ、映像、画像など）のサポート
- 開発者とサービスプロバイダーのためのクリアな法的枠組みの確立

## 2. 技術アーキテクチャ

### 2.1 コア技術スタック

- **アプリケーションフレームワーク**: Tauri（軽量で高パフォーマンスなデスクトップアプリケーション開発用）
- **フロントエンド**: Vite, TypeScript, React, Zustand（状態管理）, TanStack Query（データフェッチング）, Shadcn/UI（UIコンポーネント）
- **分散通信プロトコル**: iroh-gossip（トピックベースのメッセージ配信用）
- **データストレージ**: iroh-docs（効率的な同期プロトコルを持つ分散データベース）
- **リレーインフラストラクチャ**: Cloudflare Workers（DHT遅延を軽減）

### 2.2 高レベルアーキテクチャ

```
+------------------------+      +------------------------+
|     ユーザーノード1     |      |     ユーザーノード2     |
|                        |      |                        |
|  +------------------+  |      |  +------------------+  |
|  |   Tauriアプリ     |  |      |  |   Tauriアプリ     |  |
|  +------------------+  |      |  +------------------+  |
|          |             |      |          |             |
|  +------------------+  |      |  +------------------+  |
|  |    iroh-docs     |  |<---->|  |    iroh-docs     |  |
|  +------------------+  |      |  +------------------+  |
|          |             |      |          |             |
|  +------------------+  |      |  +------------------+  |
|  |   iroh-gossip    |  |<---->|  |   iroh-gossip    |  |
|  +------------------+  |      |  +------------------+  |
+------------------------+      +------------------------+
           /|\                             /|\
            |                               |
            |                               |
            |                               |
            v                               v
  +------------------------+      +------------------------+
  |  Cloudflare Workers   |      |   サービスプロバイダー   |
  |  (DHT遅延軽減リレー)  |      | (検索、サジェストなど)  |
  +------------------------+      +------------------------+
```

### 2.3 iroh-docsの特徴と利点

iroh-docsは、n0-computerが開発した効率的な同期プロトコルを持つ分散データストレージライブラリです。以下の特徴と利点があります：

#### 2.3.1 主要な特徴
- **マルチディメンショナルキーバリューストア**: 名前空間、キー、作成者によって識別されるエントリーを持つ柔軟なデータモデル
- **効率的な同期プロトコル**: 「範囲ベースの集合調整」アルゴリズムを使用した効率的なデータ同期
- **認証と署名**: 名前空間キーと作成者キーによる二重の署名メカニズム
- **柔軟なストレージバックエンド**: インメモリと永続的なファイルベースの実装をサポート
- **Irohエコシステムとの統合**: iroh-blobs（コンテンツアドレス指定のバイナリデータ）とiroh-gossip（ピア発見とメッセージ配信）との連携

#### 2.3.2 Automergeからの移行理由
- **パフォーマンスの向上**: より効率的な同期プロトコルによる通信オーバーヘッドの削減
- **スケーラビリティの改善**: 大規模データセットと多数のピアに対する優れた拡張性
- **リソース使用量の最適化**: メモリとCPU使用量の削減
- **Irohエコシステムとの統合**: 他のIrohコンポーネントとのシームレスな連携
- **アクティブな開発とサポート**: 継続的な改善と最新の機能追加

#### 2.3.3 アプリケーションへの影響
- **より高速な同期**: ピア間のデータ同期が効率化され、ユーザー体験が向上
- **オフライン対応の強化**: 接続が不安定な環境でも堅牢に動作
- **セキュリティの向上**: 二重署名メカニズムによるデータの整合性と認証の強化
- **将来の拡張性**: 新機能やスケーリングに対する優れた基盤の提供

## 3. 段階的実装計画

### 3.1 Phase 1: MVP（最小機能製品）

**目標**: 基本的な機能を持つ動作可能なアプリケーションの構築

#### 3.1.1 コアインフラストラクチャ
- Tauriベースのクライアントアプリケーションフレームワーク
- iroh-gossipによる基本的なP2P通信機能
- iroh-docsを使用したローカルデータストレージと同期
- 単一のCloudflare Workersリレーのプロトタイプ

#### 3.1.2 ユーザー機能
- ユーザープロフィール作成と管理
- 短文テキスト投稿とタイムライン表示
- 基本的なフォロー/フォロワー機能
- シンプルな投稿検索（ローカルのみ）

#### 3.1.3 ユーザーエクスペリエンス
- 明確で簡潔なオンボーディングプロセス
- 基本的なUIとインタラクション設計
- 最小限のエラー処理とフィードバック

#### 3.1.4 法的枠組み
- 基本的な利用規約とプライバシーポリシー
- 開発者の免責事項

**MVP完了の指標**:
- 100人のテストユーザーが投稿とインタラクションを行える
- 基本的なP2P通信が機能する
- ローカルデータの保存と同期が機能する

### 3.2 Phase 2: 拡張されたコア機能

**目標**: MVPを強化し、より堅牢な機能セットを提供

#### 3.2.1 技術的改善
- 複数のCloudflare Workersリレーのサポート
- DHT遅延軽減のさらなる最適化
- iroh-docsデータ構造の最適化（レプリカ管理、同期効率化など）
- プロトコルのパフォーマンスとスケーラビリティテスト

#### 3.2.2 機能拡張
- 画像と短い動画のサポート
- ハッシュタグと基本的なコンテンツ分類
- メンション機能とユーザー通知
- 複数のリレープロバイダーから選択する機能

#### 3.2.3 モジュールサービスの初期サポート
- 単機能サービスAPIの仕様策定と文書化
- 検索サービスプロバイダーのプロトタイプ実装
- サービス選択のための基本的なUIの実装
- サービスディレクトリ/レジストリのプロトタイプ

#### 3.2.4 法的枠組みの強化
- サービスプロバイダー向けの利用規約テンプレート
- リレーオペレーター向けのガイドライン
- サービス利用時のユーザー同意フロー

**Phase 2完了の指標**:
- 1,000人のユーザーでの安定した運用
- 少なくとも3つの異なるサービスプロバイダーの統合
- 複数のリレーノードによる分散化の強化

### 3.3 Phase 3: エコシステム拡大

**目標**: サービスプロバイダーのエコシステムを育成し、プラットフォームの機能を拡張

#### 3.3.1 サービスエコシステム
- サービスプロバイダー向けの包括的な開発ドキュメント
- サービスプロバイダー向けのSDKとツール
- サービスディレクトリの完全実装
- サービス評価とレビューシステム

#### 3.3.2 コンテンツ多様化
- 長文投稿（ブログ）機能
- ライブストリーミングのサポート
- 暗号化されたダイレクトメッセージ
- プロトコル拡張のためのプラグインシステム

#### 3.3.3 ユーザーエクスペリエンスの洗練
- カスタマイズ可能なUIテーマとレイアウト
- アクセシビリティの向上
- モバイル対応の改善
- インポート/エクスポート機能（データポータビリティ）

#### 3.3.4 モデレーションとガバナンス
- モジュール型モデレーションサービスの導入
- ユーザー主導のコミュニティガイドライン
- コンテンツフラグと報告メカニズム
- 分散型ガバナンスモデルのプロトタイプ

**Phase 3完了の指標**:
- 10,000人のアクティブユーザー
- 少なくとも10の異なるサービスプロバイダー
- 多様なコンテンツタイプのサポート

### 3.4 Phase 4: 拡張性とスケーリング

**目標**: プラットフォームを大規模に拡張するための準備

#### 3.4.1 技術スケーリング
- 大規模ネットワークでのiroh-gossipの最適化
- iroh-docsのパフォーマンス改善（大規模データセット用）
- リソース使用量の最適化
- より効率的なP2P接続とディスカバリー

#### 3.4.2 高度なサービス
- AIベースのサービスの統合（コンテンツ推薦、スパム検出など）
- 高度な検索機能（意味検索、マルチメディア検索など）
- クロスプラットフォーム連携
- サードパーティアプリケーション統合のAPI

#### 3.4.3 収益化オプション
- サービスプロバイダー向けの収益化ガイドライン
- マイクロペイメントオプション
- クリエイターサポートメカニズム
- トークンベースのインセンティブモデルのプロトタイプ

#### 3.4.4 グローバル対応
- 多言語サポートの強化
- 地域固有のコンプライアンス対応
- 異なるネットワーク条件への最適化

**Phase 4完了の指標**:
- 100,000人のアクティブユーザー
- 安定したグローバルネットワーク
- 多様なサービスプロバイダーのエコシステム

## 4. MVP詳細設計（Phase 1）

### 4.1 技術実装詳細

#### 4.1.1 Tauriアプリケーション構造
```
app/
├── src/                   # Reactアプリケーションのソースコード
│   ├── components/        # UIコンポーネント
│   ├── hooks/             # カスタムReactフック
│   ├── pages/             # ページコンポーネント
│   ├── stores/            # Zustandストア
│   ├── utils/             # ユーティリティ関数
│   ├── App.tsx            # メインアプリケーションコンポーネント
│   └── main.tsx           # エントリーポイント
├── src-tauri/             # Tauriネイティブ部分
│   ├── src/               # Rustコード
│   │   ├── main.rs        # メインエントリーポイント
│   │   ├── commands.rs    # フロントエンドとのやりとりのコマンド
│   │   ├── iroh_client.rs # iroh-gossipクライアント実装
│   │   └── storage.rs     # iroh-docストレージ実装
│   ├── Cargo.toml         # Rustの依存関係定義
│   └── tauri.conf.json    # Tauriの設定
└── package.json           # NPM依存関係
```

#### 4.1.2 データモデル
```typescript
// ユーザープロフィール
interface UserProfile {
  id: string;              // ユーザー一意のID
  displayName: string;     // 表示名
  bio: string;             // 自己紹介
  avatar: string;          // アバター画像（URL/Base64）
  following: string[];     // フォロー中のユーザーID
  followers: string[];     // フォロワーのユーザーID
  createdAt: number;       // 作成日時（タイムスタンプ）
  updatedAt: number;       // 更新日時（タイムスタンプ）
}

// 投稿
interface Post {
  id: string;              // 投稿ID
  authorId: string;        // 投稿者ID
  content: string;         // 投稿内容
  attachments: string[];   // 添付ファイル（URL/Base64）
  mentions: string[];      // メンションされたユーザーID
  hashtags: string[];      // ハッシュタグ
  createdAt: number;       // 作成日時（タイムスタンプ）
}

// アプリケーション設定
interface AppSettings {
  userId: string;          // 現在のユーザーID
  selectedRelays: string[]; // 選択されたリレーのURL
  theme: 'light' | 'dark'; // テーマ設定
  language: string;        // 言語設定
}
```

#### 4.1.3 iroh-gossipトピック構造
```
topics/
├── user/{userId}/profile      # ユーザープロフィール更新
├── user/{userId}/posts        # ユーザーの投稿
├── global/posts               # グローバルな投稿フィード
└── announcements              # システムアナウンス
```

#### 4.1.4 Cloudflare Workersリレー設計
```javascript
// Cloudflare Workersのpseudoコード
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  // クロスオリジンリクエストを許可
  if (request.method === 'OPTIONS') {
    return handleCORS(request)
  }

  // パスに基づいてリクエストをルーティング
  const url = new URL(request.url)
  const path = url.pathname

  if (path.startsWith('/relay')) {
    return handleRelayRequest(request)
  }

  if (path.startsWith('/discovery')) {
    return handleDiscoveryRequest(request)
  }

  // その他のリクエストは404を返す
  return new Response('Not Found', { status: 404 })
}

async function handleRelayRequest(request) {
  try {
    // リクエストボディからメッセージを取得
    const message = await request.json()
    
    // メッセージの検証
    if (!isValidMessage(message)) {
      return new Response('Invalid message format', { status: 400 })
    }
    
    // メッセージをKVに保存
    await storeMessage(message)
    
    // 成功応答
    return new Response(JSON.stringify({ success: true }), {
      headers: { 'Content-Type': 'application/json' }
    })
  } catch (error) {
    return new Response(`Error: ${error.message}`, { status: 500 })
  }
}
```

### 4.2 ユーザーインターフェース設計

#### 4.2.1 主要画面
- **ログイン/新規ユーザー画面**: 初回起動時の登録/ログイン
- **ホームタイムライン**: フォロー中のユーザーと自分の投稿
- **プロフィール画面**: ユーザープロフィールと投稿履歴
- **リレー選択画面**: 利用するリレーの設定
- **設定画面**: アプリケーション設定

#### 4.2.2 オンボーディングフロー
1. アプリケーション初回起動
2. 利用規約と免責事項の同意
3. ユーザープロフィール作成
4. リレーサーバーの選択（デフォルト提供）
5. 基本的な機能の説明チュートリアル

### 4.3 MVP必須機能の詳細

#### 4.3.1 ユーザー認証
- 公開鍵暗号を使用したユーザーID生成
- ローカルストレージでの鍵管理
- サインイン/サインアウト機能

#### 4.3.2 投稿機能
- テキスト投稿作成（最大500文字）
- タイムライン表示
- 投稿の永続化と同期

#### 4.3.3 ユーザーインタラクション
- プロフィール閲覧
- フォロー/アンフォロー機能
- 基本的な投稿検索（ローカルのみ）

#### 4.3.4 データ同期
- iroh-docsによるデータ同期
- オフライン対応の基本機能
- 初期同期プロセスの最適化
- 効率的なレプリカ管理と同期プロトコル

### 4.4 法的枠組み（MVP）

#### 4.4.1 利用規約
- ユーザーの責任と義務
- コンテンツポリシー
- アプリケーション使用条件
- 開発者の免責条項

#### 4.4.2 プライバシーポリシー
- 収集される情報
- データの使用方法
- ユーザーの権利
- サードパーティサービスとの関係

#### 4.4.3 同意フロー
- アプリケーション初回起動時の同意取得
- リレーサービス使用時の同意取得
- 同意の記録と管理

### 4.5 MVPのテスト計画

#### 4.5.1 機能テスト
- ユーザー認証フローのテスト
- 投稿作成と表示のテスト
- フォロー/アンフォロー機能のテスト
- データ同期のテスト

#### 4.5.2 パフォーマンステスト
- 起動時間の測定
- メモリ使用量の監視
- ネットワーク帯域幅の使用状況
- 低速ネットワーク環境下でのテスト

#### 4.5.3 ユーザビリティテスト
- 初期ユーザーグループによるフィードバック収集
- オンボーディングプロセスの評価
- ユーザーインターフェースの使いやすさの評価

## 5. Phase 2-4の強化ポイント

### 5.1 単機能サービス統合の設計（Phase 2）

#### 5.1.1 サービスAPI仕様
- サービス認証メカニズム
- データ交換フォーマット
- エラー処理とステータスコード
- レート制限とクォータ

#### 5.1.2 サービスディレクトリ
- サービス登録メカニズム
- メタデータと機能説明
- ユーザーレビューと評価システム
- ディスカバリーメカニズム

### 5.2 コンテンツモデレーションアプローチ（Phase 3）

#### 5.2.1 モジュール型モデレーションサービス
- モデレーションサービスAPI仕様
- コンテンツフラグと報告システム
- モデレーション結果の処理と適用
- 異なるモデレーションポリシーの並存

#### 5.2.2 ユーザー主導のモデレーション
- コミュニティガイドライン設定
- ユーザーによるコンテンツフラグ付け
- モデレーター役割と責任
- 異議申し立てプロセス

### 5.3 収益化戦略（Phase 4）

#### 5.3.1 サービスプロバイダー向け
- 有料サービスオプション
- サブスクリプションモデル
- マイクロトランザクション
- 広告統合ガイドライン

#### 5.3.2 クリエイターサポート
- 寄付/チップシステム
- クリエイターサブスクリプション
- コンテンツロック解除メカニズム
- トークンベースの報酬システム

## 6. リスクと緩和策

### 6.1 技術的リスク

| リスク | 影響度 | 緩和策 |
|-------|-------|-------|
| iroh-gossipの安定性と成熟度 | 高 | 早期からのプロトタイピングとストレステスト、代替プロトコルの評価 |
| iroh-docsのパフォーマンス制限 | 中 | データモデルの最適化、レプリカ管理戦略の改善、同期プロトコルの効率化 |
| Cloudflare Workersの利用制限 | 中 | 使用状況の注意深い監視、早期の有料プランへの移行計画 |
| クライアントのリソース消費 | 中 | パフォーマンスプロファイリング、最適化、リソース使用量の制限 |

### 6.2 ユーザー採用リスク

| リスク | 影響度 | 緩和策 |
|-------|-------|-------|
| 複雑なオンボーディング | 高 | 簡素化されたUIとチュートリアル、デフォルト設定の提供 |
| コンテンツ不足 | 高 | インポートツール、既存プラットフォームからの移行支援 |
| サービスプロバイダーの不足 | 高 | 初期サービスの開発、開発者向けインセンティブプログラム |
| ネットワーク効果の欠如 | 高 | 特定のニッチコミュニティへの焦点、独自の価値提案 |

### 6.3 法的リスク

| リスク | 影響度 | 緩和策 |
|-------|-------|-------|
| コンテンツ責任の不明確さ | 高 | 強固な利用規約と免責条項、法的専門家との協議 |
| 地域固有の規制 | 中 | 法的要件の調査、地域ごとの設定オプション |
| プライバシー法令遵守 | 中 | プライバシーバイデザインの採用、透明なデータ処理 |
| サービスプロバイダーの違法行為 | 中 | サービス審査プロセス、問題報告メカニズム |

## 7. 成功の尺度

### 7.1 ユーザー指標

- アクティブユーザー数の成長率
- ユーザーリテンション率
- ユーザー生成コンテンツの量と質
- ユーザーエンゲージメントレベル

### 7.2 技術的指標

- システム安定性とアップタイム
- 平均同期時間
- リソース使用効率
- バグとクラッシュの頻度

### 7.3 エコシステム指標

- 独立したサービスプロバイダーの数と多様性
- リレーオペレーターの数と地理的分布
- サービスと機能の利用率
- 開発者コミュニティの活動と貢献

## 8. 結論

本設計書は、モジュール型分散型ソーシャルネットワークアプリケーションの構築とそのエコシステム育成のための段階的なアプローチを概説しています。MVPの構築から始め、徐々に機能を拡張していくことで、ユーザーとサービスプロバイダーのバランスの取れたエコシステムの成長を促進します。

このアプローチにより、以下のような利点が期待されます：

1. **早期フィードバック**: MVPを通じて早期からユーザーフィードバックを収集し、製品開発に活かせます
2. **リスク軽減**: 段階的開発により、技術的リスクを早期に特定し対処できます
3. **エコシステム成長**: 明確なAPI仕様とドキュメントにより、サービスプロバイダーの参入障壁を下げます
4. **ユーザーニーズへの適応**: フィードバックに基づいて優先事項を調整し、ユーザーニーズに合わせて進化させることができます

このプロジェクトの成功は、技術的な実装だけでなく、活発なコミュニティとエコシステムの構築にかかっています。モジュール型の分散アーキテクチャを採用することで、ユーザーとサービスプロバイダーの両方に柔軟性と選択肢を提供し、より健全で持続可能なソーシャルネットワークを実現します。